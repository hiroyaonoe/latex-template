name: latex

on: push

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "Pull image"
        run: |
          docker pull ghcr.io/hiroyaonoe/texlive:latest

      - name: "Run latexmk"
        id: latexmk
        run: docker run --mount type=bind,src=${{ github.workspace }},dst=/work ghcr.io/hiroyaonoe/texlive:latest latexmk

      - name: "Output log if failure"
        if: failure() && steps.latexmk.outcome == 'failure'
        run: cat main.log

      - name: "Set filename"
        id: filename
        run: |
          FILENAME=${GITHUB_REPOSITORY#${GITHUB_REPOSITORY_OWNER}/}-main-$(git rev-parse --short ${{ github.sha }}).pdf
          echo ::set-output name=FILENAME::${FILENAME}

      - name: "Upload artifact main.pdf"
        uses: actions/upload-artifact@v2
        with:
          name: ${{ steps.filename.outputs.FILENAME }}
          path: main.pdf
  
  release:
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v2

      - name: "Download artifact main.pdf"
        uses: actions/download-artifact@v3
        with:
          name: bthesis-onoe_main

      - name: "Rename main.pdf"
        id: rename
        run: |
          REPO=${GITHUB_REPOSITORY#${GITHUB_REPOSITORY_OWNER}/}
          NEW_FILENAME=${REPO}-main-${GITHUB_REF/refs\/tags\//}.pdf
          mv main.pdf ${NEW_FILENAME}
          echo ::set-output name=FILENAME::${NEW_FILENAME}
      
      - name: "Release"
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.rename.outputs.FILENAME }}
